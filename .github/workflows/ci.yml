name: CI - Development Branch Validation

on:
  push:
    branches: [ Dev ]   # Trigger when code is merged into Dev
  pull_request:
    branches: [ Dev ]   # Optional: also runs on PRs targeting Dev
  workflow_dispatch:     # Manual trigger

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.4"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install ZenML integrations here so they exist before registration
          zenml integration install mlflow s3 -y

      - name: Initialize and Configure ZenML
        working-directory: "(3) K-Nearest Neighbors"
        env:
          ARTIFACT_PATH: ${{ vars.ARTIFACT_PATH }}
          TRACKER_URL: ${{ vars.TRACKER_URL }}
          TRACKER_USER: ${{ vars.TRACKER_USER }}
          DB_URL: ${{ vars.DB_URL }}
          ARTIFACT_URL: ${{ vars.ARTIFACT_URL }}

          ARTIFACT_KEY: ${{ secrets.ARTIFACT_KEY }}
          ARTIFACT_SECRET: ${{ secrets.ARTIFACT_SECRET }}
          TRACKER_PASSWORD: ${{ secrets.TRACKER_PASSWORD }}
          TRACKER_TOKEN: ${{ secrets.TRACKER_TOKEN }}
          DB_KEY: ${{ secrets.DB_KEY }}

          PYTHONPATH: ${{ github.workspace }}/(3) K-Nearest Neighbors

        run: |
          echo "::group::üîß Initialize ZenML Repository"
          zenml init
          echo "::endgroup::"

          echo "::group::üîê Create ZenML Secrets"
          zenml secret create artifact_secrets \
            --aws_access_key_id="$ARTIFACT_KEY" \
            --aws_secret_access_key="$ARTIFACT_SECRET"

          zenml secret create mlflow_secret \
            --username="$TRACKER_USER" \
            --password="$TRACKER_PASSWORD"
          echo "::endgroup::"

          echo "::group::üóÑÔ∏è Register ZenML Components"
          zenml artifact-store register Supabase \
            --flavor=s3 \
            --path="$ARTIFACT_PATH"            

          zenml experiment-tracker register mlflow_tracker \
            --flavor=mlflow \
            --authentication_secret=mlflow_secret
          echo "::endgroup::"

          echo "::group::üß© Register ZenML Stack"
          zenml stack register ci_stack \
            -a Supabase \
            -o default \
            -e mlflow_tracker \
            --set 
          echo "::endgroup::"

          echo "::group::üì¶ Update Artifact Store"
          python update_artifact.py
          zenml artifact-store describe  
          echo "::endgroup::"


      - name: Run Tests and Training
        working-directory: "(3) K-Nearest Neighbors"
        env:
          DB_URL: ${{ vars.DB_URL }}
          DB_KEY: ${{ secrets.DB_KEY }}
          PYTHONPATH: ${{ github.workspace }}/(3) K-Nearest Neighbors
        run: |
          echo "üß™ Running tests..."
          pytest tests/test_ingest.py --maxfail=1 --disable-warnings -q

          echo "üöÄ Running training pipeline..."
          zenml stack set ci_stack
          python train.py
