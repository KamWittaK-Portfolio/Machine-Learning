name: CI - Development Branch Validation

on:
  push:
    branches: [ Dev ]   # Triggers when code is merged into dev
  pull_request:
    branches: [ Dev ]   # Optional: also runs on PRs targeting dev
  workflow_dispatch:     # Manual trigger

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.4"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Initialize ZenML repo

        run: |
          zenml init

          echo "ARTIFACT_PATH=$ARTIFACT_PATH"
          echo "TRACKER_URL=$TRACKER_URL"
          echo "TRACKER_USER=$TRACKER_USER"
          echo "ARTIFACT_KEY=$ARTIFACT_KEY"
          echo "ARTIFACT_SECRET=$ARTIFACT_SECRET"

          # Create secrets
          zenml secret create artifact_secrets --aws_access_key_id="$ARTIFACT_KEY" --aws_secret_access_key="$ARTIFACT_SECRET"
          zenml secret create mlflow_secret --username="$TRACKER_USER" --password="$TRACKER_PASSWORD"
        
          # Register artifact store
          zenml artifact-store register Supabase -f s3 --path="$ARTIFACT_PATH" --authentication_secret=artifact_secrets

          # Register experiment tracker referencing the secret
          zenml experiment-tracker register mlflow_tracker --flavor=mlflow --authentication_secret=mlflow_secret

          # Register and set stack
          zenml stack register ci_stack -a Supabase -o default -e mlflow_tracker --set

          # Install integrations
          zenml integration install mlflow s3

      

      - name: Run unit and integration tests
        working-directory: "(3) K-Nearest Neighbors"
        env:
          DB_URL: ${{ env.DB_URL }}
          DB_KEY: ${{ secrets.DB_KEY }}
          PYTHONPATH: ${{ github.workspace }}/(3) K-Nearest Neighbors
        run: |
          pytest tests/test_ingest.py --maxfail=1 --disable-warnings -q
